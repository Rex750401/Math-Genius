<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="數學天才">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/180/calculator.png">
    
    <title>直式位值練習場 - 完美對齊版</title>
    <style>
        :root {
            --bg-color: #FFF9F0;
            --primary-pink: #FF8AB4;
            --secondary-blue: #4A90E2;
            --carry-red: #FF4757;
            -webkit-user-select: none; 
            user-select: none;
        }

        body {
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            display: flex; flex-direction: column; align-items: center; padding: 15px;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .control-panel {
            background: white; padding: 15px; border-radius: 20px; border: 3px solid #FFD93D;
            text-align: center; margin-bottom: 20px; width: 100%; max-width: 500px;
        }

        .quiz-item {
            background: white; border-radius: 25px; padding: 20px; margin-bottom: 25px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); width: 100%; max-width: 600px;
        }

        .math-container {
            display: flex; justify-content: center; align-items: flex-end;
            font-size: 3rem; font-weight: bold; gap: 8px; height: 90px;
            margin-bottom: 10px;
        }

        .digit-group { 
            position: relative; 
            display: inline-flex; 
            letter-spacing: 2px;
        }

        /* 標記樣式：修正位置使其不再偏右 */
        .mark {
            position: absolute; font-size: 1.1rem; font-weight: 900; 
            top: -25px; 
            display: none; width: 30px; text-align: center;
        }

        /* 調整 left 數值，讓標記準確對齊十位與百位 */
        .carry-ten { left: -5px; color: var(--carry-red); }
        .carry-hundred { left: -35px; color: var(--carry-red); }
        
        .borrow-mark {
            top: -25px; color: #444; font-size: 1rem;
            background: #FFD93D; border-radius: 4px; padding: 0 2px;
        }
        .borrow-ten { left: -5px; }

        /* 十位數字單獨槓掉效果 */
        .strike-ten {
            position: relative;
            color: #bbb;
        }
        .strike-ten::after {
            content: "/";
            position: absolute;
            left: 4px;
            top: 0;
            color: red;
            font-weight: bold;
            transform: scale(1.2);
        }

        .answer-zone {
            display: flex;
            flex-direction: row-reverse; 
            gap: 4px;
            align-items: center;
        }

        .digit-input {
            width: 42px; height: 55px; font-size: 2rem;
            border: 3px solid #eee; border-radius: 8px; text-align: center;
            color: var(--secondary-blue); font-weight: bold;
        }

        .digit-input:focus { border-color: var(--primary-pink); outline: none; background: #FFF0F5; }

        .btn-group { display: flex; gap: 8px; margin: 15px 0; justify-content: center; }

        .btn-tool {
            padding: 8px 15px; border-radius: 10px; border: none;
            color: white; font-weight: bold; cursor: pointer; font-size: 0.9rem;
        }

        .bg-add { background-color: var(--carry-red); }
        .bg-sub { background-color: #57606f; }

        .ten-frame-group { display: flex; gap: 8px; justify-content: center; margin-top: 15px; }
        .ten-frame {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px;
            padding: 6px; background: #f0faff; border: 2px solid #bcd; border-radius: 8px;
        }
        .dot { width: 26px; height: 26px; background: #ddd; border-radius: 50%; cursor: pointer; }
        .dot.active { background: var(--primary-pink); }
    </style>
</head>
<body>

    <h1 style="color: #FF6B6B; font-size: 1.5rem; margin: 10px 0;">✏️數學小天才✏️</h1>

    <div class="control-panel">
        <div style="margin-bottom:10px;">
            <label><input type="radio" name="mode" value="add" checked> 加法</label>
            <label><input type="radio" name="mode" value="sub"> 減法</label>
            <label><input type="radio" name="mode" value="mix"> 混合</label>
        </div>
        <button class="btn-tool" style="background: #FF8AB4; width: 160px;" onclick="generateQuiz()">換題目</button>
    </div>

    <div id="quiz-container"></div>

    <script>
        function toggleMark(btn, className) {
            const item = btn.closest('.quiz-item');
            const mark = item.querySelector('.' + className);
            const isVisible = mark.style.display === 'block';
            mark.style.display = isVisible ? 'none' : 'block';

            if (className === 'borrow-ten') {
                const tenDigitSpan = item.querySelector('.ten-digit');
                const leftDots = item.querySelectorAll('.ten-frame')[0].querySelectorAll('.dot');
                if (!isVisible) {
                    tenDigitSpan.classList.add('strike-ten'); 
                    leftDots.forEach(d => d.classList.add('active'));
                } else {
                    tenDigitSpan.classList.remove('strike-ten');
                    leftDots.forEach(d => d.classList.remove('active'));
                }
            }
        }

        function moveFocus(current, nextId) {
            if (current.value.length >= 1) {
                const nextInput = current.closest('.quiz-item').querySelector('.' + nextId);
                if (nextInput) nextInput.focus();
            }
        }

        function generateQuiz() {
            const container = document.getElementById('quiz-container');
            const mode = document.querySelector('input[name="mode"]:checked').value;
            container.innerHTML = '';

            for (let i = 0; i < 5; i++) {
                let n1 = Math.floor(Math.random() * 80) + 11;
                let n2 = Math.floor(Math.random() * 80) + 11;
                let op = (mode === 'mix') ? (Math.random() > 0.5 ? 'add' : 'sub') : mode;
                if (op === 'sub' && n1 < n2) [n1, n2] = [n2, n1];

                const n1Str = n1.toString().padStart(2, '0');
                const tenD = n1Str[0];
                const unitD = n1Str[1];

                const quizItem = document.createElement('div');
                quizItem.className = 'quiz-item';
                
                const buttons = op === 'add' ? `
                    <button class="btn-tool bg-add" onclick="toggleMark(this, 'carry-ten')">十位進位</button>
                    <button class="btn-tool bg-add" onclick="toggleMark(this, 'carry-hundred')">百位進位</button>
                ` : `
                    <button class="btn-tool bg-sub" onclick="toggleMark(this, 'borrow-ten')">十位借位</button>
                `;

                quizItem.innerHTML = `
                    <div class="math-container">
                        <div class="digit-group">
                            <div class="mark carry-hundred">+1</div>
                            <div class="mark carry-ten">+1</div>
                            <div class="mark borrow-mark borrow-ten">${parseInt(tenD)-1}</div>
                            <span class="ten-digit">${tenD}</span><span class="unit-digit">${unitD}</span>
                        </div>
                        <span>${op === 'add' ? '+' : '-'}</span>
                        <span>${n2}</span>
                        <span>=</span>
                        <div class="answer-zone">
                            <input type="number" pattern="[0-9]*" inputmode="numeric" class="digit-input unit" oninput="moveFocus(this, 'tens')" placeholder="個">
                            <input type="number" pattern="[0-9]*" inputmode="numeric" class="digit-input tens" oninput="moveFocus(this, 'hundreds')" placeholder="十">
                            <input type="number" pattern="[0-9]*" inputmode="numeric" class="digit-input hundreds" placeholder="百">
                        </div>
                    </div>
                    <div class="btn-group">${buttons}</div>
                    <div class="ten-frame-group">
                        <div class="ten-frame">${Array(10).fill('<div class="dot" onclick="this.classList.toggle(\'active\')"></div>').join('')}</div>
                        <div class="ten-frame">${Array(10).fill('<div class="dot" onclick="this.classList.toggle(\'active\')"></div>').join('')}</div>
                    </div>
                    <p style="text-align:right; font-size:0.75rem; color:#ccc; cursor:pointer;" onclick="resetItem(this)">重置</p>
                `;
                container.appendChild(quizItem);
            }
        }

        function resetItem(btn) {
            const item = btn.closest('.quiz-item');
            item.querySelectorAll('.mark').forEach(m => m.style.display = 'none');
            item.querySelector('.ten-digit').classList.remove('strike-ten');
            item.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
            item.querySelectorAll('.digit-input').forEach(input => input.value = '');
        }

        generateQuiz();
    </script>
</body>
</html>
